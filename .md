# SnagLog API

Backend API for SnagLog - AI-powered snagging reports.

## Tech Stack

- **Node.js** + Express
- **Prisma** ORM + PostgreSQL (Railway)
- **Clerk** for authentication
- **Claude AI** (Anthropic) for image analysis
- **Cloudflare R2** for image/PDF storage
- **Stripe** for payments
- **Puppeteer** for PDF generation

## Live URLs

- **API:** https://api.snaglog.co.uk
- **App:** https://app.snaglog.co.uk
- **Landing:** https://snaglog.co.uk

## Project Structure

```
snaglog-api/
├── src/
│   ├── index.js          # Express app entry point
│   ├── routes/
│   │   ├── upload.js     # Photo upload + R2 storage
│   │   ├── analyze.js    # Claude AI analysis
│   │   ├── report.js     # CRUD for reports/snags
│   │   └── payment.js    # Stripe checkout
│   └── lib/
│       ├── prisma.js     # Prisma client
│       ├── r2.js         # Cloudflare R2 uploads
│       ├── claude.js     # Claude API integration
│       └── pdf.js        # PDF generation
├── prisma/
│   └── schema.prisma     # Database schema
├── package.json
└── .env
```

## Environment Variables

```env
# Database
DATABASE_URL=postgresql://...

# Clerk Auth
CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...

# Anthropic (Claude AI)
ANTHROPIC_API_KEY=sk-ant-...

# Cloudflare R2
R2_ACCOUNT_ID=...
R2_ACCESS_KEY_ID=...
R2_SECRET_ACCESS_KEY=...
R2_BUCKET_NAME=snaglog
R2_PUBLIC_URL=https://pub-xxx.r2.dev

# Stripe
STRIPE_SECRET_KEY=sk_test_... (or sk_live_...)
STRIPE_PRICE_ID=price_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Frontend URL (for CORS & redirects)
FRONTEND_URL=https://app.snaglog.co.uk
```

## Database Schema

```prisma
model Report {
  id              String   @id @default(uuid())
  userId          String
  propertyAddress String
  propertyType    String?
  developerName   String?
  inspectionDate  DateTime @default(now())
  status          Status   @default(DRAFT)
  paymentStatus   PaymentStatus @default(UNPAID)
  stripePaymentId String?
  pdfUrl          String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  snags           Snag[]
}

model Snag {
  id             String   @id @default(uuid())
  reportId       String
  report         Report   @relation(...)
  photoUrl       String
  room           String?
  defectType     String?
  description    String?
  severity       Severity @default(MINOR)
  suggestedTrade String?
  remedialAction String?
  aiConfidence   Float?
  userEdited     Boolean  @default(false)
  displayOrder   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum Status { DRAFT, ANALYZING, REVIEW, GENERATING, COMPLETE }
enum PaymentStatus { UNPAID, PAID, DEMO }
enum Severity { MINOR, MODERATE, MAJOR }
```

## API Endpoints

### Upload
- `POST /api/upload` - Upload photos, create report

### Analyze
- `POST /api/analyze/:reportId` - Run AI analysis on all snags
- `POST /api/analyze/:reportId/snag/:snagId` - Re-analyze single snag

### Reports
- `GET /api/report` - Get all reports for user
- `GET /api/report/:reportId` - Get single report with snags
- `PATCH /api/report/:reportId` - Update report details
- `PATCH /api/report/:reportId/snag/:snagId` - Update snag
- `DELETE /api/report/:reportId/snag/:snagId` - Delete snag
- `DELETE /api/report/:reportId` - Delete report

### Payment
- `POST /api/payment/checkout/:reportId` - Create Stripe checkout
- `POST /api/payment/webhook` - Stripe webhook handler
- `GET /api/payment/success/:reportId` - Handle successful payment

## Local Development

```bash
# Install dependencies
npm install

# Set up environment variables
cp .env.example .env
# Edit .env with your values

# Push database schema
npx prisma db push

# Run development server
npm run dev
```

## Deployment (Railway)

The app auto-deploys from GitHub to Railway.

**Start command:**
```
npx prisma generate && npx prisma db push && node src/index.js
```

## Key Features

1. **Photo Upload** - Accepts JPEG, PNG, HEIC (auto-converted)
2. **AI Analysis** - Claude Vision identifies defects, severity, trades
3. **PDF Generation** - Professional reports with Puppeteer
4. **Stripe Integration** - £19.99 per report payment
5. **CORS** - Configured for app.snaglog.co.uk

## CORS Configuration

```javascript
app.use(cors({
  origin: [
    'https://app.snaglog.co.uk',
    'https://snaglog-app-production.up.railway.app',
    'http://localhost:5173'
  ],
  credentials: true
}));
```

## Troubleshooting

**CORS errors:** Check origin array includes the requesting domain

**Upload timeout:** Large photos need compression on frontend

**AI analysis fails:** Check ANTHROPIC_API_KEY and image URLs are accessible

**Payment redirect fails:** Check FRONTEND_URL is set correctly

## Related Repos

- **snaglog-app** - Frontend React app
- **snaglog** - Landing page
